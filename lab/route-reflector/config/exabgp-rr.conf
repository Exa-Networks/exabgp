# BGP Route Reflector Configuration for Lab
# Demonstrates AS-PATH-based route filtering
#
# Topology:
#   Upstream (AS 65001) → ExaBGP (AS 65000) → Clients (AS 65002, 65003)
#   Filter API: Google routes → Client1, Microsoft routes → Client2
#
# All BGP speakers connect to ExaBGP on port 1790
# ExaBGP identifies neighbors by peer ASN in OPEN message

# API Filter Process
# Path must be absolute or relative to working directory where exabgp is run
process filter-api {
	run python3 ./lab/route-reflector/scripts/filter_api.py;
	encoder json;
}

# Upstream Neighbor (sends routes with Google/Microsoft AS-PATH)
# ExaBGP will accept incoming connection based on peer-as in OPEN message
neighbor 127.0.0.1 {
	router-id 1.2.3.4;
	local-address 127.0.0.1;
	local-as 65000;
	peer-as 65001;

	# Passive mode - do not initiate connection, listen on port 1790
	passive true;
	listen 1790;

	# Long hold-time to avoid keepalive complexity
	hold-time 180;

	family {
		ipv4 unicast;
	}

	capability {
		asn4 enable;
		route-refresh enable;
	}

	# API configuration - receive updates from this neighbor
	api {
		processes [ filter-api ];
		receive {
			parsed;
			update;
		}
	}
}

# Client 1 (receives Google routes - AS 15169)
# ExaBGP will accept incoming connection based on peer-as in OPEN message
neighbor 127.0.0.1 {
	router-id 1.2.3.4;
	local-address 127.0.0.1;
	local-as 65000;
	peer-as 65002;

	# Passive mode - do not initiate connection, listen on port 1790
	passive true;
	listen 1790;

	hold-time 180;

	family {
		ipv4 unicast;
	}

	capability {
		asn4 enable;
	}

	# API configuration - send routes to this neighbor via API
	api {
		processes [ filter-api ];
	}
}

# Client 2 (receives Microsoft routes - AS 8075)
# ExaBGP will accept incoming connection based on peer-as in OPEN message
neighbor 127.0.0.1 {
	router-id 1.2.3.4;
	local-address 127.0.0.1;
	local-as 65000;
	peer-as 65003;

	# Passive mode - do not initiate connection, listen on port 1790
	passive true;
	listen 1790;

	hold-time 180;

	family {
		ipv4 unicast;
	}

	capability {
		asn4 enable;
	}

	# API configuration - send routes to this neighbor via API
	api {
		processes [ filter-api ];
	}
}
