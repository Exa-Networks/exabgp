#!/usr/bin/env python3

import sys
import time

from exabgp_api import send, wait_for_ack, wait_for_shutdown

# Test sequence:
# 1. Send a regular announce command and expect ACK (baseline test)
# 2. Send disable-ack command and expect ACK (last ACK before disabling)
# 3. Send another announce command and expect NO ACK (should timeout)
# 4. Send enable-ack command and expect ACK (re-enabling)
# 5. Send final announce command and expect ACK (verify re-enabled)


def fail(msg: str) -> None:
    """Write error message to stderr and flush."""
    sys.stderr.write(msg)
    sys.stderr.flush()


def main() -> None:
    time.sleep(0.2)  # let the EOR pass

    # Step 1: Baseline - send command and expect ACK
    send('announce route 1.1.0.0/24 next-hop 101.1.101.1')
    time.sleep(0.1)

    if not wait_for_ack(expected_count=1):
        fail('ERROR: Baseline test failed - no ACK received for announce\n')
        sys.exit(1)

    # Step 2: Send disable-ack command and expect final ACK
    send('disable-ack')
    time.sleep(0.1)

    if not wait_for_ack(expected_count=1):
        fail('ERROR: No ACK received for disable-ack command\n')
        sys.exit(1)

    # Step 3: Send command and expect NO ACK (should timeout)
    send('announce route 1.2.0.0/24 next-hop 101.1.101.1')
    time.sleep(0.1)

    if wait_for_ack(expected_count=1, timeout=1):
        fail('ERROR: Received unexpected ACK after disable-ack\n')
        sys.exit(1)

    # Step 4: Send enable-ack command and expect ACK
    send('enable-ack')
    time.sleep(0.1)

    if not wait_for_ack(expected_count=1):
        fail('ERROR: No ACK received for enable-ack command\n')
        sys.exit(1)

    # Step 5: Send final command and expect ACK (verify re-enabled)
    send('announce route 1.3.0.0/24 next-hop 101.1.101.1')
    time.sleep(0.1)

    if not wait_for_ack(expected_count=1):
        fail('ERROR: No ACK received after enable-ack\n')
        sys.exit(1)

    # All tests passed
    fail('SUCCESS: All ACK control tests passed\n')

    wait_for_shutdown()


if __name__ == '__main__':
    main()
