#!/usr/bin/env python3

import sys
import time

from exabgp_api import send, wait_for_ack, wait_for_shutdown

# Test sequence:
# 1. Send a regular announce command and expect ACK (baseline test)
# 2. Send silence-ack command and expect NO ACK (immediate silence, no ACK for this command)
# 3. Send another announce command and expect NO ACK (should timeout)
# 4. Send enable-ack command and expect ACK (re-enabling)
# 5. Send final announce command and expect ACK (verify re-enabled)


def fail(msg: str) -> None:
    """Write error message to stderr and flush."""
    sys.stderr.write(msg)
    sys.stderr.flush()


def main() -> None:
    time.sleep(0.2)  # let the EOR pass

    # Step 1: Baseline - send command and expect ACK
    send('announce route 2.1.0.0/24 next-hop 102.1.102.1')
    time.sleep(0.1)

    if not wait_for_ack(expected_count=1):
        fail('ERROR: Baseline test failed - no ACK received for announce\n')
        sys.exit(1)

    # Step 2: Send silence-ack command and expect NO ACK (immediate silence)
    send('silence-ack')
    time.sleep(0.1)

    if wait_for_ack(expected_count=1, timeout=1):
        fail('ERROR: Received unexpected ACK for silence-ack command (should be immediate silence)\n')
        sys.exit(1)

    # Step 3: Send command and expect NO ACK (should still be silent)
    send('announce route 2.2.0.0/24 next-hop 102.1.102.1')
    time.sleep(0.1)

    if wait_for_ack(expected_count=1, timeout=1):
        fail('ERROR: Received unexpected ACK after silence-ack\n')
        sys.exit(1)

    # Step 4: Send enable-ack command and expect ACK
    send('enable-ack')
    time.sleep(0.1)

    if not wait_for_ack(expected_count=1):
        fail('ERROR: No ACK received for enable-ack command\n')
        sys.exit(1)

    # Step 5: Send final command and expect ACK (verify re-enabled)
    send('announce route 2.3.0.0/24 next-hop 102.1.102.1')
    time.sleep(0.1)

    if not wait_for_ack(expected_count=1):
        fail('ERROR: No ACK received after enable-ack\n')
        sys.exit(1)

    # All tests passed
    fail('SUCCESS: All silence-ack tests passed\n')

    wait_for_shutdown()


if __name__ == '__main__':
    main()
