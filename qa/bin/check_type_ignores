#!/usr/bin/env python3
"""
Check for prohibited # type: comments in the codebase.

This script scans for ANY # type: comments and fails if found.
All type annotations must use Python 3.12+ inline syntax.

Prohibited patterns:
  # type: ignore
  # type: ignore[error-code]
  # type: SomeType  (Python 2 style annotation)

Usage:
    ./qa/bin/check_type_ignores          # Check and fail if any found
    ./qa/bin/check_type_ignores --show   # Show all locations
"""

from __future__ import annotations

import argparse
import re
import sys
from pathlib import Path

SRC_DIR = Path(__file__).parent.parent.parent / 'src' / 'exabgp'

# Pattern to match ANY # type: comment (ignore, type annotations, etc.)
TYPE_COMMENT_PATTERN = re.compile(r'#\s*type\s*:')


def find_type_comments() -> dict[str, list[tuple[int, str]]]:
    """Find all # type: comments in the codebase."""
    results: dict[str, list[tuple[int, str]]] = {}

    for py_file in SRC_DIR.rglob('*.py'):
        # Skip vendored files
        if 'vendoring' in str(py_file):
            continue

        rel_path = str(py_file.relative_to(SRC_DIR.parent.parent))
        matches: list[tuple[int, str]] = []

        try:
            with open(py_file, 'r', encoding='utf-8') as f:
                for line_num, line in enumerate(f, 1):
                    if TYPE_COMMENT_PATTERN.search(line):
                        matches.append((line_num, line.rstrip()))
        except Exception as e:
            print(f'Error reading {py_file}: {e}', file=sys.stderr)
            continue

        if matches:
            results[rel_path] = matches

    return results


def count_comments(results: dict[str, list[tuple[int, str]]]) -> int:
    """Count total number of # type: comments."""
    return sum(len(matches) for matches in results.values())


def show_comments(results: dict[str, list[tuple[int, str]]]) -> None:
    """Display all # type: comment locations."""
    for filepath in sorted(results.keys()):
        matches = results[filepath]
        print(f'\n{filepath}:')
        for line_num, line in matches:
            print(f'  {line_num}: {line[:100]}')


def main() -> int:
    parser = argparse.ArgumentParser(description='Check for prohibited # type: comments')
    parser.add_argument('--show', action='store_true', help='Show all locations')
    args = parser.parse_args()

    results = find_type_comments()
    current_count = count_comments(results)

    if args.show:
        if results:
            show_comments(results)
            print(f'\nTotal: {current_count} # type: comments in {len(results)} files')
        else:
            print('No # type: comments found')
        return 0

    # Check mode - fail if ANY # type: comments found
    if current_count > 0:
        print(f'FAIL: Found {current_count} prohibited # type: comments in {len(results)} files')
        print()
        print('All # type: comments are prohibited. Use Python 3.12+ inline annotations instead:')
        print('  Bad:  x = value  # type: int')
        print('  Good: x: int = value')
        print()
        print('Run with --show to see all locations')
        return 1

    print('OK: No # type: comments found')
    return 0


if __name__ == '__main__':
    sys.exit(main())
